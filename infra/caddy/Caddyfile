# Caddy reverse proxy configuration for SecondMe
# Provides HTTPS termination and routing for production deployment

# Main dashboard
{$DOMAIN:localhost} {
    # Automatic HTTPS with Let's Encrypt (production)
    # For local development, Caddy uses self-signed certificates

    # Frontend (Next.js)
    reverse_proxy frontend:3000

    # WebSocket support for Socket.io
    @websockets {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    handle @websockets {
        reverse_proxy frontend:3000
    }

    # API routes
    handle /api/* {
        reverse_proxy frontend:3000
    }

    # Static assets
    handle /_next/* {
        reverse_proxy frontend:3000
    }

    # Health check endpoint
    handle /health {
        respond "OK" 200
    }

    # Security headers
    header {
        # Enable HSTS (HTTP Strict Transport Security)
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

        # Prevent clickjacking
        X-Frame-Options "DENY"

        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"

        # XSS protection
        X-XSS-Protection "1; mode=block"

        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"

        # Content Security Policy
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' ws: wss:; font-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none';"

        # Remove server header for security
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
        }
        format json
    }
}

# Gateway service (internal only - not exposed publicly)
:3001 {
    bind 127.0.0.1
    reverse_proxy gateway:3001
}

# Orchestrator service (internal only - not exposed publicly)
:3002 {
    bind 127.0.0.1
    reverse_proxy orchestrator:3002
}

# Graph Worker service (internal only - not exposed publicly)
:3003 {
    bind 127.0.0.1
    reverse_proxy graph-worker:3003
}
